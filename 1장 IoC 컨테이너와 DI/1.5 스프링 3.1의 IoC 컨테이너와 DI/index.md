# 1.5

+ 스프링 3.1의 가장 큰 특징은 자바 코드를 이용한 설정 메타정보 작성이 쉽다는 점이다. 그래서 XML을 사용하지 않거나 최소화한 채로 스프링 애플리케이션 개발이 가능하다. (그렇다고 XML 없는 개발을 강제하지는 않는다.)

  > XML 설정은 구시대 방식이라고 여겨지기도 하지만, 빈 설정 메타정보를 자바 코드와 분리된 XML 문서로 작성하고 관리하는 방법에는 여러 가지 장점이 있어서 선호되는 환경이 있다.

  > XML 설정을 사용해 개발을 진행하고 애플리케이션을 운영, 유지보수하는 것이 여러 면에서 유리하기도 하다. 반대로 자동인식과 관례를 최대한 활용해서 명시적인 설정정보의 양을 최소화하고 툴의 지원을 통해 편리하고 안전하게 개발할 수 있는 자바 코드 방식이 선호되기도 한다.

<br>

#### 빈의 역할과 구분

> 스프링에서 사용되는 빈을 역할과 성격에 따라서 구분하면 빈 메타정보의 역할 속성을 기준으로 `애플리케이션 빈`과 `인프라 빈`으로 나눌 수 있다.

+ 애플리케이션 로직 빈

  일반적으로 애플리케이션의 로직을 담고 있는 주요 클래스의 객체가 빈으로 지정된다. DAO, 서비스 객체, 컨트롤러 객체 등이 대표적이다.

+ 애플리케이션 인프라 빈

  애플리케이션이 동작하는 데 참여하지만, 개발자가 직접 작성하는 로직을 담고 있는 것은 아니다. DataSource처럼 외부 리소스와의 연결을 관리하면서 DAO 객체에 제공해주기도 하고, DataSourceTransactionManager처럼 서비스 빈이 특정 트랜잭션 기술에 종속되지 않도록 부가기능을 제공해주기도 한다.

+ 컨테이너 인프라 빈

  스프링 컨테이너의 기능을 확장해서 빈의 등록과 생성, 관계설정, 초기화 등의 작업에 참여하는 빈을 말한다.

  > IoC /DI 컨테이너의 기능을 확장하는 방법은 확장 기능을 가진 객체를 스프링의 빈으로 등록하는 것이다. BeanPostProcessor나 BeanFactoryPostProcessor 같은 인터페이스를 구현한 클래스가 빈으로 되어 있으면 스프링 컨테이너는 스스로를 확장하는 데 이를 사용한다.

<br>

#### IoC/DI 설정 방법의 발전

+ 초기에는 XML에서 `<bean>` 태그를 사용해야 빈을 등록할 수 있었지만 스프링 버전이 업데이트 되면서 빈 스캐너와 스테레오타입 어노테이션(`@Repository`, `@Component`, `@Service` ...) 사용 방식으로 바뀌어 갔다.

+ `스프링 3.0` : 자바 코드를 이용해 빈 설정정보 또는 빈 설정 코드를 만드는 것 가능

  `<bean>`을 이용한 빈 설정 메타 정보 작성 방식을 모두 버리고 자바 코드와 어노테이션만으로 애플리케이션 빈 설정을 할 수 있다. 하지만 컨테이너 인프라 빈은 여전히 XML을 이용해 정의해야 한다.

+ `스프링 3.1` : 컨테이너 인프라 빈도 자바 코드로 등록 가능

<br>

+ `@Configuration` 어노테이션을 이용하여 Bean 설정 파일(XML 파일을 대체하는)임을 알려주고, `@ComponentScan` 어노테이션을 이용해 빈으로 등록되기 위한 어노테이션이 부여된 클래스들을 자동으로 IoC 컨테이너에 등록하도록 한다.

  > @Configuration 같은 어노테이션은 `<context:annotation-config/>` 전용 태그에 의해 등록되는 컨테이너 인프라 빈이 스프링 컨테이너의 기능을 확장해줬기 때문에 사용할 수 있다.

  > @ComponentScan은 스테레오 타입 어노테이션이 붙은 클래스를 모두 찾아서 빈으로 등록한다.

+ 스프링 3.1에서는 `@Bean` 메소드가 없어도 컨테이너 인프라 빈의 설정을 위해 `@Configuration` 클래스를 사용할 수도 있다.

  ```java
  @ComponentScan
  @Configuration
  public class ApplicationConfig {}
  ```

  > 스프링 부트를 사용한다면 `@SpringBootApplication` 어노테이션이 `@ComponentScan` 어노테이션을 들고 있기 때문에 보기 힘들다.

<br>

+ @Configuration 클래스는 각각 하나의 XML 파일과 같다고 볼 수 있다. 만약 성격이 다른 빈 설정들이 하나의 파일에 섞여 있다면 여러 개의 파일로 분리해서 관리하는 것이 좋다. (SRP)

+ @Configuration으로 설정한 설정 파일을 두 개 이상 사용하는 경우엔 @Import를 사용하면 된다. (클래스는 다중 상속이 불가능하기 때문)

  > 컨테이너 인프라 빈을 위한 전용 어노테이션을 만들 때 더 많이 사용된다.

+ XML이 꼭 필요한 빈 설정을 별도의 파일로 작성한 뒤에 @Configuration 클래스에서 @ImportResource를 이용하면 XML 파일의 빈 설정을 가져올 수 있다.

  이 외에도 XML의 전용 태그를 대체한 어노테이션을 사용할 수 있다.

  > @EnableAspectJAutoProxy, @EnableAsync, @EnableWebMvc ...

<br>

+ 스프링의 빈 설정 메타정보는 빈의 클래스와 값 속성, 다른 빈과의 관계로 이루어져 있다. 애플리케이션의 기능이 바뀌지 않는다면 메타정보도 대부분 바뀌지 않는다.

  > 외부 리소스나 서버환경과 관련이 깊은 애플리케이션 인프라 빈의 클래스와 속성은 같은 애플리케이션이라고 하더라도 실행환경에 따라 달라질 수 있다.

<br>

+ 런타임 환경은 profile과 property source로 구성되어, 컨텍스트 내부에 Environment 인터페이스를 구현한 런타임 환경 객체가 만들어져서 빈을 생성하거나 의존관계를 주입할 때 사용된다.

+ profile은 한 번에 두 가지 이상을 활성화할 수도 있다. 프로필에서 정의되는 빈의 개수는 제한이 없다. 프로필이 다르면 정의되는 빈의 클래스뿐 아니라 개수가 달라질 수도 있다. 

<br>

+ XML이나 @Configuration 클래스로 작성하는 빈의 메타정보는 애플리케이션의 기능과 구현 방법이 변경되지 않는 이상 변경할 필요가 없어야 한다. DB 연결정보처럼 환경에 따라서 달라지는 것은 빈 메타정보에 두기보다는 프로퍼티 파일 같은 별도의 리소스를 사용해 분리하는 편이 바람직하다.
+ 외부 리소스에 따라 바뀔 수 있는 DB 연결 정보같은 것은 빈 메타정보 외부로 독립시켜 ${} 치환자를 사용해 파일로부터 정보를 가져오도록 한다.

+ Properties가 기본적으로 지원하는 프로퍼티 파일은 ISO-8859-1 인코딩만을 지원하기 때문에 영문만 사용할 수 있다.(표현 불가능할 때는 유니코드 값을 사용)

<br>

#### 스프링에서 사용되는 프로퍼티의 종류

+ 환경변수 : 스프링 애플리케이션이 구동되는 OS의 환경변수로, 키와 값으로 표현되는 대표적인 프로퍼티이다. 같은 시스템에서 여러 개의 WAS를 구동하더라도 모두 동일하게 적용되는 매우 넓은 범위에 적용되는 프로퍼티이다.
+ 시스템 프로퍼티 : JVM이 시작될 때 시스템 관련 정보부터 자바 관련 정보, 기타 JVM 관련 정보 등이 시스템 프로퍼티로 등록된다. WAS 단위로 동일한 활성 프로필을 지정하고 싶다면 -D 옵션을 이용해 시스템 프로퍼티를 지정하면 된다.
+ JNDI : WAS에 올라간 여러 개의 웹 애플리케이션 중 하나의 애플리케이션에만 프로퍼티를 지정하고 싶다면 JNDI 프로퍼티/JVDI 환경 값을 사용할 수 있다.
+ 서블릿 컨텍스트 파라미터
+ 서블릿 컨픽 파라미터

<br>

+ 두 개 이상의 프로퍼티에서 양쪽에 동일한 키의 프로퍼티가 중복해서 존재하면 런타임 환경 오브젝트에 등록된 프로퍼티 소스의 우선순위를 따라 사용된다. StandardEnvironment에서는 시스템 프로퍼티가 환경변수 프로퍼티보다 우선순위가 높다.
+ 프로퍼티 소스를 환경 오브젝트에 직접 추가할 때는 우선순위를 함께 지정해줘야 한다. addFirst(), addBefore() ...
+ `@Value("${db.username}") private String username;` 처럼 @Value에 치환자를 사용하려면 컨텍스트에 PropertySourcePlaceholderConfigurer 빈이 등록되어 있어야 한다.

<br>

+ @PropertySource로 등록되는 프로퍼티 소스는 컨텍스트에 기본적으로 등록되는 프로퍼티 소스보다 우선순위가 낮다. @Configuration 클래스에 @PropertySource 어노테이션을 붙이고 프로퍼티 파일 위치를 기본 엘리먼트 값으로 넣어 사용할 수 있다.

+ 활성 프로필 정보는 `spring.profiles.active`라는 키를 가진 프로퍼티를 프로퍼티 소스에서 찾아서 사용한다. 

  > 파일 이름을 application-{profile}.properties로 설정하면 별도의 설정 없이 사용할 수 있다.

  
